<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Flask + iubenda Integration</title>

    <style>
      :root {
        --bg: #0b1020;
        --surface: #12172a;
        --text: #e7ecff;
        --muted: #9aa3c7;
        --accent: #6ea8fe;
        --accent-2: #9b9bff;
        --border: #2a3150;
        --btn-bg: #1a2140;
        --btn-hover: #232a4f;
        --ring: 0 0 0 8px rgba(110,168,254,0.12);
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f8ff;
          --surface: #ffffff;
          --text: #1b2430;
          --muted: #5c667a;
          --accent: #2f6bff;
          --accent-2: #6b5bff;
          --border: #e7ebf6;
          --btn-bg: #f1f4ff;
          --btn-hover: #e7edff;
          --ring: 0 0 0 8px rgba(47,107,255,0.10);
        }
      }

      * { box-sizing: border-box; }
      html, body {
        height: 100%;
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: radial-gradient(1200px 600px at 70% -10%, rgba(110,168,254,0.12), transparent 60%),
                    radial-gradient(1000px 500px at -10% 20%, rgba(155,155,255,0.12), transparent 60%),
                    var(--bg);
        color: var(--text);
      }

      .wrap {
        min-height: 100%;
        display: grid;
        place-items: center;
        padding: 32px 16px;
      }
      
      .user { font-size:2rem; margin-bottom:1rem; }
      .perm { font-size:1.2rem; color:#9aa3c7; }
      
      .user-info {
        display: grid;
        gap: 12px;
        padding: 16px;
        margin-bottom: 20px;
        border-radius: 14px;
        background: linear-gradient(180deg, rgba(110,168,254,0.06), transparent 70%);
        border: 1px solid var(--border);
      }
      .user-info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border);
      }
      .user-info-item:last-child {
        border-bottom: none;
      }
      .user-info-label {
        color: var(--muted);
        font-size: 14px;
      }
      .user-info-value {
        color: var(--text);
        font-size: 14px;
        font-weight: 500;
      }
      .user-info-value.granted {
        color: #00ff7f;
      }
      .user-info-value.denied {
        color: #ff5555;
      }

      .card {
        width: 100%;
        max-width: 820px;
        background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0)) , var(--surface);
        border: 1px solid var(--border);
        border-radius: 20px;
        box-shadow:
          0 20px 40px rgba(0,0,0,0.25),
          inset 0 1px 0 rgba(255,255,255,0.04);
        padding: 28px;
      }

      .header {
        display: grid;
        gap: 6px;
        margin-bottom: 20px;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--btn-bg);
        border: 1px solid var(--border);
        color: var(--muted);
        font-size: 12px;
        letter-spacing: 0.02em;
        width: fit-content;
      }
      .title {
        font-size: clamp(22px, 3.5vw, 32px);
        line-height: 1.2;
        margin: 0;
      }
      .subtitle {
        margin: 0;
        color: var(--muted);
        font-size: 15px;
      }

      .panel {
        display: grid;
        gap: 14px;
        padding: 16px;
        border-radius: 14px;
        background: linear-gradient(180deg, rgba(110,168,254,0.08), transparent 70%);
        border: 1px dashed var(--border);
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 6px;
      }

      /* Convert your iubenda links into neat pill buttons */
      .policy-btn {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--btn-bg);
        color: var(--text);
        text-decoration: none !important;
        line-height: 1;
        transition: transform 0.08s ease, background 0.2s ease, border-color 0.2s ease;
        will-change: transform;
      }
      .policy-btn:hover {
        background: var(--btn-hover);
        border-color: color-mix(in srgb, var(--border), var(--accent) 35%);
        transform: translateY(-1px);
      }
      .policy-btn:focus-visible {
        outline: none;
        box-shadow: var(--ring);
      }

      .hint {
        margin: 16px 0 0 0;
        color: var(--muted);
        font-size: 13px;
      }

      .footer {
        margin-top: 24px;
        padding-top: 16px;
        border-top: 1px solid var(--border);
        display: flex;
        justify-content: space-between;
        gap: 10px;
        color: var(--muted);
        font-size: 13px;
      }
      .footer a { color: var(--accent); text-decoration: none; }
      .footer a:hover { text-decoration: underline; }
    </style>
  </head>

    <script>
      var _iub = _iub || [];
      _iub.csConfiguration = {
        siteId: "f4d20c40-87b0-457b-92f1-6ef81768a055",
        cookiePolicyId: 44515695,
        lang: "en",
        banner: {
          position: "bottom",
          acceptButtonDisplay: true,
          rejectButtonDisplay: true,
          customizeButtonDisplay: true
        },
        callback: {
          onPreferenceExpressedOrNotNeeded: function (preference) {
            try {
              // If GDPR/US laws don't apply, preference can be undefined
              // if (!preference) {
                // You could choose to treat "not needed" as granted access:
              //  window.location.href = "/access-granted";
              //  return;
              // }
              
              // According to iubenda documentation, the preference object structure is:
              // {
              //   id: "xxxxx",                    // Unique consent ID
              //   consent: true/false/undefined,   // Overall consent (if binary)
              //   purposes: {                      // Granular purpose consents
              //     "1": true/false,              // Purpose ID -> boolean or numeric (4 = accepted)
              //     "2": true/false,
              //     ...
              //   },
              //   ccpa: "1YN-",                   // Optional: CCPA string
              //   uspr: {                          // Optional: US Privacy preferences
              //     s: true,                       // Sale
              //     sh: true,                      // Sharing
              //     adv: true                      // Advertising
              //   },
              //   tcfv2: {...},                    // Optional: TCF v2 data
              //   gac: {...}                       // Optional: Google Additional Consent
              // }
              
              // Save consent preferences to backend (for current user)
              async function saveConsentToBackend(consentData) {
                try {
                  const response = await fetch("/save-consent", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(consentData),
                  });
                  
                  if (response.ok) {
                    const result = await response.json();
                    console.log("Consent saved for user:", result.user_id);
                  } else {
                    console.error("Failed to save consent:", await response.text());
                  }
                } catch (e) {
                  console.error("Error saving consent:", e);
                }
              }
              
              if (preference.consent === true) {
                // User clicked Accept all ‚Üí Save and continue
                saveConsentToBackend(preference).then(() => {
                  window.location.href = "/access-granted";
                });
              } else if (preference.consent === false) {
                // User clicked Reject all ‚Üí Save and continue
                saveConsentToBackend(preference).then(() => {
                  window.location.href = "/access-denied";
                });
              } else if (preference.uspr ) {
                // US State Law granular choice (CCPA, CPRA, VCDPA, etc.)
                // According to iubenda docs for US state laws:
                // {
                //   id: "xxxxx",
                //   uspr: {                          // US Privacy preferences
                //     s: true/false,                  // Sale consent
                //     sh: true/false,                 // Sharing consent
                //     adv: true/false                 // Advertising consent
                //   },
                //   ccpa: "1YN-",                    // CCPA string (1=opt-out, Y=yes, N=no, - = not applicable)
                //   purposes: {...}                   // Optional: purpose-based consents
                // }
                console.log("US State Law consent preferences:", preference);
                console.log("US Privacy (uspr):", preference.uspr);
                console.log("CCPA string:", preference.ccpa);
                if (preference.purposes) {
                  console.log("Purposes:", preference.purposes);
                }
                
                saveConsentToBackend(preference).then(() => {
                  // For US state laws, check uspr or ccpa to determine access
                  // Example: grant access if user hasn't opted out of sale (ccpa doesn't start with "1")
                  // or if uspr.s (sale) is true
                  let hasConsent = false;
                  
                  
                  // if (preference.uspr) {
                    // If any US Privacy preference is true, grant access
                    hasConsent = preference.uspr.s === true || 
                                 preference.uspr.sh === true || 
                                 preference.uspr.adv === true;
                  /**
                  } 
                  a
                  else if (preference.ccpa) {
                    // CCPA: "1" at start means opt-out, otherwise consent given
                    hasConsent = !preference.ccpa.startsWith("1");
                  } else if (preference.purposes) {
                    // Fallback to purposes if available
                    hasConsent = Object.values(preference.purposes).some(
                      v => v === true || v === 4 || v === "4"
                    );
                  }
                  */
                  window.location.href = hasConsent ? "/access-granted" : "/access-denied";
                });
              }
               
              else {
                // Fallback: save whatever preference data we have
                console.log("Saving preference data (no granular choices detected):", preference);
                saveConsentToBackend(preference || {}).then(() => {
                  window.location.href = "/access-granted";
                });
              }
              
            } catch (e) {
              console.error("iubenda redirect error:", e);
            }
          }
        }
      };
    </script>
    <script async charset="UTF-8" src="https://cdn.iubenda.com/cs/iubenda_cs.js"></script>

  <body>
    <main class="wrap">
      <section class="card" aria-labelledby="site-title">
        <div class="header">
          <span class="badge" aria-label="Location">üìç Boelter Hall 5272</span>
          <h1 id="site-title" class="title">Welcome</h1>
          <p class="subtitle">Please review our cookie and privacy policies below.</p>
        </div>
        
        <div class="user" id="user-name">No face detected</div>
        <div class="perm" id="user-perm"></div>
        
        <div class="user-info" id="user-info-section" style="display: none;">
          <div class="user-info-item">
            <span class="user-info-label">User ID:</span>
            <span class="user-info-value" id="user-id-display">-</span>
          </div>
          <div class="user-info-item">
            <span class="user-info-label">Permission Status:</span>
            <span class="user-info-value" id="permission-status-display">-</span>
          </div>
          <div class="user-info-item" id="us-state-law-section" style="display: none;">
            <span class="user-info-label">US Privacy Choices:</span>
            <span class="user-info-value" id="us-state-law-display">-</span>
          </div>
        </div>
        
        <div class="panel" role="region" aria-label="Policies">
          <strong>Policies</strong>
          <div class="actions">
            <!-- PRIVACY POLICY -->
            <a
              href="https://www.iubenda.com/privacy-policy/44515695"
              class="policy-btn iubenda-white iubenda-noiframe iubenda-embed iubenda-noiframe"
              title="Privacy Policy"
            >
              <!-- simple icon -->
              <span aria-hidden="true">üîí</span>
              Privacy Policy
            </a>

            <!-- COOKIE POLICY -->
            <a
              href="https://www.iubenda.com/privacy-policy/44515695/cookie-policy"
              class="policy-btn iubenda-white iubenda-noiframe iubenda-embed iubenda-noiframe"
              title="Cookie Policy"
            >
              <span aria-hidden="true">üç™</span>
              Cookie Policy
            </a>
          </div>

          <p class="hint">
            We use essential cookies and, with your consent, analytics to improve the experience.
            You can adjust your choices anytime via the floating preferences button.
          </p>
        </div>

        <div class="footer">
          <span>¬© <span id="y"></span> Boelter Hall 5272</span>
          <span>Powered by Flask ¬∑ iubenda Cookie Solution</span>
        </div>
      </section>
    </main>

    <!-- One global loader for your policy links (consolidated) -->
    <script type="text/javascript">
      (function (w, d) {
        var loader = function () {
          var s = d.createElement("script"), tag = d.getElementsByTagName("script")[0];
          s.src = "https://cdn.iubenda.com/iubenda.js";
          tag.parentNode.insertBefore(s, tag);
        };
        if (w.addEventListener) { w.addEventListener("load", loader, false); }
        else if (w.attachEvent) { w.attachEvent("onload", loader); }
        else { w.onload = loader; }
      })(window, document);
    </script>

    <!-- Example: block analytics until consent -->
    <script type="text/plain" data-cookiecategory="analytics">
      console.log("Analytics would initialize here after consent.");
    </script>
    
    <script>
      async function refresh() {
        try {
          const r = await fetch("/status");
          const data = await r.json();
          const user = document.getElementById("user-name");
          const perm = document.getElementById("user-perm");
          const userInfoSection = document.getElementById("user-info-section");
          const userIdDisplay = document.getElementById("user-id-display");
          const permissionStatusDisplay = document.getElementById("permission-status-display");

          if (data.status === "match" || data.status === "unknown") {
            user.textContent = data.name || "Unknown";
            
            // Handle permission states: 0 = first time, 1 = denied, 2 = granted
            const permission = parseInt(data.permission) || 0;
            if (permission === 0) {
              perm.textContent = "‚è≥ First time visiting - no decision yet";
              perm.style.color = "#9aa3c7";
            } else if (permission === 2) {
              perm.textContent = "‚ùå Access denied";
              perm.style.color = "#ff5555";
            } else if (permission === 1) {
              perm.textContent = "‚úÖ Access granted";
              perm.style.color = "#00ff7f";
            }
            
            // Show user info section
            userInfoSection.style.display = "grid";
            userIdDisplay.textContent = data.user_id !== null ? data.user_id : "N/A";
            
            // Update permission status display
            if (permission === 0) {
              permissionStatusDisplay.textContent = "‚è≥ Pending";
              permissionStatusDisplay.className = "user-info-value";
              permissionStatusDisplay.style.color = "#9aa3c7";
            } else if (permission === 2) {
              permissionStatusDisplay.textContent = "‚ùå Denied";
              permissionStatusDisplay.className = "user-info-value denied";
              permissionStatusDisplay.style.color = ""; // Reset to use CSS class color
            } else if (permission === 1) {
              permissionStatusDisplay.textContent = "‚úÖ Granted";
              permissionStatusDisplay.className = "user-info-value granted";
              permissionStatusDisplay.style.color = ""; // Reset to use CSS class color
            }
            
            // Display US State Law preferences if available
            const usStateLawSection = document.getElementById("us-state-law-section");
            const usStateLawDisplay = document.getElementById("us-state-law-display");
            console.log("467");
            if (data.granular_consent) {
              console.log("469");
              const consent = data.granular_consent;
              let usStateLawText = "";
              
              if (consent.uspr) {
                console.log("474");
                // US Privacy preferences
                const uspr = consent.uspr;
                const choices = [];
                if (uspr.s !== undefined) choices.push(`Sale: ${uspr.s ? "‚úÖ" : "‚ùå"}`);
                if (uspr.sh !== undefined) choices.push(`Sharing: ${uspr.sh ? "‚úÖ" : "‚ùå"}`);
                if (uspr.adv !== undefined) choices.push(`Advertising: ${uspr.adv ? "‚úÖ" : "‚ùå"}`);
                usStateLawText = choices.join(", ");
              } else if (consent.ccpa) {
                // CCPA string format
                const ccpa = consent.ccpa;
                const optOut = ccpa.startsWith("1") ? "Opted out" : "Consented";
                usStateLawText = `CCPA: ${optOut} (${ccpa})`;
              }
              
              if (usStateLawText) {
                usStateLawSection.style.display = "flex";
                usStateLawDisplay.textContent = usStateLawText;
              } else {
                usStateLawSection.style.display = "none";
              }
            } else {
              usStateLawSection.style.display = "none";
            }
          } else {
            user.textContent = "No face detected";
            perm.textContent = "";
            userInfoSection.style.display = "none";
          }
        } catch (e) {
          console.error("Failed to fetch status:", e);
        }
      }

      let lastPermission = null;
      let lastUserId = null;
      
      async function refresh() {
        try {
          const r = await fetch("/status");
          const data = await r.json();
          const user = document.getElementById("user-name");
          const perm = document.getElementById("user-perm");
          const userInfoSection = document.getElementById("user-info-section");
          const userIdDisplay = document.getElementById("user-id-display");
          const permissionStatusDisplay = document.getElementById("permission-status-display");

          if (data.status === "match" || data.status === "unknown") {
            user.textContent = data.name || "Unknown";
            
            // Handle permission states: 0 = first time, 1 = agree, 2 = disagree
            const permission = parseInt(data.permission) || 0;
            const userId = data.user_id;
            
            // Check if permission changed (for auto-refresh on voice changes)
            if (userId === lastUserId && permission !== lastPermission) {
              console.log("Permission changed detected, updating UI immediately");
            }
            lastPermission = permission;
            lastUserId = userId;
            
            if (permission === 0) {
              perm.textContent = "‚è≥ First time visiting - no decision yet";
              perm.style.color = "#9aa3c7";
            } else if (permission === 2) {
              perm.textContent = "‚ùå Access denied";
              perm.style.color = "#ff5555";
            } else if (permission === 1) {
              perm.textContent = "‚úÖ Access granted";
              perm.style.color = "#00ff7f";
            }
            
            // Show user info section
            userInfoSection.style.display = "grid";
            userIdDisplay.textContent = data.user_id !== null ? data.user_id : "N/A";
            
            // Update permission status display
            if (permission === 0) {
              permissionStatusDisplay.textContent = "‚è≥ Pending";
              permissionStatusDisplay.className = "user-info-value";
              permissionStatusDisplay.style.color = "#9aa3c7";
            } else if (permission === 2) {
              permissionStatusDisplay.textContent = "‚ùå Denied";
              permissionStatusDisplay.className = "user-info-value denied";
              permissionStatusDisplay.style.color = ""; // Reset to use CSS class color
            } else if (permission === 1) {
              permissionStatusDisplay.textContent = "‚úÖ Granted";
              permissionStatusDisplay.className = "user-info-value granted";
              permissionStatusDisplay.style.color = ""; // Reset to use CSS class color
            }
            
            // Display US State Law preferences if available
            const usStateLawSection = document.getElementById("us-state-law-section");
            const usStateLawDisplay = document.getElementById("us-state-law-display");
            if (data.granular_consent) {
              const consent = data.granular_consent;
              let usStateLawText = "";
              
              if (consent.uspr) {
                // US Privacy preferences
                const uspr = consent.uspr;
                const choices = [];
                if (uspr.s !== undefined) choices.push(`Sale: ${uspr.s ? "‚úÖ" : "‚ùå"}`);
                if (uspr.sh !== undefined) choices.push(`Sharing: ${uspr.sh ? "‚úÖ" : "‚ùå"}`);
                if (uspr.adv !== undefined) choices.push(`Advertising: ${uspr.adv ? "‚úÖ" : "‚ùå"}`);
                usStateLawText = choices.join(", ");
              } else if (consent.ccpa) {
                // CCPA string format
                const ccpa = consent.ccpa;
                const optOut = ccpa.startsWith("1") ? "Opted out" : "Consented";
                usStateLawText = `CCPA: ${optOut} (${ccpa})`;
              }
              
              if (usStateLawText) {
                usStateLawSection.style.display = "flex";
                usStateLawDisplay.textContent = usStateLawText;
              } else {
                usStateLawSection.style.display = "none";
              }
            } else {
              usStateLawSection.style.display = "none";
            }
          } else {
            user.textContent = "No face detected";
            perm.textContent = "";
            userInfoSection.style.display = "none";
            lastPermission = null;
            lastUserId = null;
          }
        } catch (e) {
          console.error("Failed to fetch status:", e);
        }
      }

      refresh();
      setInterval(refresh, 500); // poll every 0.5 s for faster updates
    </script>

    <script async charset="UTF-8" src="https://cdn.iubenda.com/cs/iubenda_cs.js"></script>
  </body>
</html>


